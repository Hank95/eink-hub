<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>E-Ink Hub</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        max-width: 900px;
        margin: 40px auto;
        padding: 0 16px;
      }
      h1 {
        margin-bottom: 0.25rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
      }
      button {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #f5f5f5;
        cursor: pointer;
      }
      button:hover {
        background: #e5e5e5;
      }
      img.preview {
        max-width: 100%;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .status {
        font-size: 0.9rem;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h1>E-Ink Display Hub</h1>
    <div class="status" id="status"></div>

    <h2>Current Preview</h2>
    <div id="preview-container">
      <em>No image yet.</em>
    </div>

    <h2>Layouts</h2>
    <div class="grid">
      <div class="card">
        <h3>Daily Rundown</h3>
        <p>Calendar, today’s run, and a basic summary.</p>
        <button onclick="setDailyRundown()">Send to Display</button>
      </div>

      <div class="card">
        <h3>Photo Frame</h3>
        <p>Upload a photo and show it on the e-ink display.</p>
        <form id="upload-form">
          <input type="file" name="file" accept="image/*" required /><br /><br />
          <input
            type="text"
            name="caption"
            placeholder="Caption (optional)"
            style="width: 100%;"
          />
          <br /><br />
          <button type="submit">Upload & Show</button>
        </form>
      </div>
      <div class="card">
        <h3>Strava Dashboard</h3>
        <p>Weekly mileage and a simple run summary.</p>
        <button onclick="setStravaDashboard()">Send to Display</button>
      </div>
    </div>

    <script>
      async function refreshStatus() {
        const res = await fetch("/api/status");
        const data = await res.json();
        const statusEl = document.getElementById("status");
        if (data.current_layout) {
          statusEl.textContent =
            "Current layout: " +
            data.current_layout +
            " · Last updated: " +
            (data.last_updated || "unknown");
        } else {
          statusEl.textContent = "No layout has been displayed yet.";
        }

        const previewContainer = document.getElementById("preview-container");
        try {
          const imgUrl = "/api/preview";
          // Try loading preview image by setting src
          previewContainer.innerHTML =
            '<img class="preview" src="' +
            imgUrl +
            '" alt="Preview" onerror="this.style.display=\'none\'; document.getElementById(\'preview-container\').innerHTML=\'<em>No image yet.</em>\';" />';
        } catch (e) {
          previewContainer.innerHTML = "<em>No image yet.</em>";
        }
      }

      async function setDailyRundown() {
        await fetch("/api/display", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ layout: "daily_rundown", options: {} }),
        });
        await refreshStatus();
      }
      
      async function setStravaDashboard() {
        await fetch("/api/display", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ layout: "strava_dashboard", options: {} }),
        });
        await refreshStatus();
      }

      const uploadForm = document.getElementById("upload-form");
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        const uploadRes = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });
        const uploadData = await uploadRes.json();
        const imagePath = uploadData.image_path;
        const caption = uploadData.caption || "";

        await fetch("/api/display", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            layout: "photo_frame",
            options: { photo_path: imagePath, caption },
          }),
        });
        uploadForm.reset();
        await refreshStatus();
      });

      // Initial load
      refreshStatus();
      // Optional: refresh periodically
      setInterval(refreshStatus, 15000);
    </script>
  </body>
</html>
