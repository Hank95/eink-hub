<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Ink Hub</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #fafafa;
      }
      h1 {
        margin-bottom: 0.25rem;
        color: #222;
      }
      h2 {
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        margin-top: 24px;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
      }
      .mode-toggle {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .mode-toggle button {
        padding: 8px 16px;
      }
      .mode-toggle button.active {
        background: #333;
        color: white;
        border-color: #333;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        background: white;
      }
      .card h3 {
        margin-top: 0;
        color: #333;
      }
      .card p {
        color: #666;
        font-size: 0.9rem;
      }
      button {
        padding: 8px 14px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #f5f5f5;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
      }
      button:hover {
        background: #e5e5e5;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      img.preview {
        max-width: 100%;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        color: #555;
        padding: 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 16px;
      }
      .status-bar .layout-name {
        font-weight: 600;
        color: #333;
      }
      .preview-container {
        background: white;
        padding: 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        text-align: center;
      }
      .providers-section {
        margin-top: 24px;
      }
      .provider-list {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .provider-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.85rem;
      }
      .provider-badge.enabled {
        border-color: #4caf50;
      }
      .provider-badge.disabled {
        opacity: 0.5;
      }
      .provider-badge.error {
        border-color: #f44336;
        background: #fff5f5;
      }
      .provider-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc;
      }
      .provider-status.ok {
        background: #4caf50;
      }
      .provider-status.error {
        background: #f44336;
      }
      .provider-refresh {
        padding: 4px 8px;
        font-size: 0.75rem;
        margin-left: 4px;
      }
      input[type="file"],
      input[type="text"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      input[type="text"] {
        width: 100%;
      }
      .last-updated {
        font-size: 0.8rem;
        color: #888;
      }
      .nav-link {
        color: #0066cc;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .nav-link:hover {
        text-decoration: underline;
      }
      /* Image Gallery Styles */
      .gallery-section {
        margin-top: 24px;
      }
      .gallery-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
      }
      .gallery-header h2 {
        margin: 0;
        border: none;
        padding: 0;
      }
      .gallery-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }
      .gallery-item {
        aspect-ratio: 4/3;
        border: 2px solid #ddd;
        border-radius: 6px;
        overflow: hidden;
        cursor: pointer;
        transition: border-color 0.2s, transform 0.2s;
        background: #f0f0f0;
      }
      .gallery-item:hover {
        border-color: #888;
        transform: scale(1.02);
      }
      .gallery-item.selected {
        border-color: #333;
        border-width: 3px;
      }
      .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .gallery-empty {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px;
        color: #888;
        font-style: italic;
      }
      .image-preview-section {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
      }
      .image-preview-section h3 {
        margin-top: 0;
        margin-bottom: 12px;
      }
      .image-preview-container {
        text-align: center;
        background: #f5f5f5;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 16px;
      }
      .image-preview-container img {
        max-width: 100%;
        border: 1px solid #ccc;
      }
      .image-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        margin-bottom: 16px;
      }
      .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .control-group label {
        font-weight: 500;
        font-size: 0.9rem;
      }
      .rotation-buttons {
        display: flex;
        gap: 4px;
      }
      .rotation-buttons button {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
      .rotation-buttons button.active {
        background: #333;
        color: white;
      }
      .fit-mode-buttons {
        display: flex;
        gap: 4px;
      }
      .fit-mode-buttons button {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
      .fit-mode-buttons button.active {
        background: #333;
        color: white;
      }
      .image-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .image-actions button {
        padding: 10px 20px;
      }
      .btn-primary {
        background: #333;
        color: white;
        border-color: #333;
      }
      .btn-primary:hover {
        background: #444;
      }
      .btn-danger {
        background: #fff;
        color: #d32f2f;
        border-color: #d32f2f;
      }
      .btn-danger:hover {
        background: #ffebee;
      }
      .upload-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #eee;
      }
      .upload-form {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .image-info {
        font-size: 0.85rem;
        color: #666;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1>E-Ink Display Hub</h1>
        <a href="/sensors" class="nav-link">View Sensor History &rarr;</a>
      </div>
      <div class="mode-toggle">
        <span>Mode:</span>
        <button id="btn-manual" onclick="setMode('manual')">Manual</button>
        <button id="btn-auto" onclick="setMode('auto_rotate')">Auto-Rotate</button>
      </div>
    </div>

    <div class="status-bar">
      <div>
        <span>Current: </span>
        <span class="layout-name" id="current-layout">None</span>
      </div>
      <div class="last-updated" id="last-updated"></div>
    </div>

    <div class="preview-container" id="preview-container">
      <em>No preview yet</em>
    </div>

    <h2>Layouts</h2>
    <div class="grid" id="layouts-grid">
      <!-- Layouts will be populated dynamically -->
    </div>

    <div class="providers-section">
      <h2>Data Providers</h2>
      <div class="provider-list" id="providers-list">
        <!-- Providers will be populated dynamically -->
      </div>
    </div>

    <!-- Image Gallery Section -->
    <div class="gallery-section">
      <div class="gallery-header">
        <h2>Photo Gallery</h2>
        <div class="gallery-controls">
          <label>
            <input type="checkbox" id="photo-auto-rotate" onchange="togglePhotoAutoRotate()" />
            Auto-Rotate Photos
          </label>
        </div>
      </div>

      <div class="gallery-grid" id="gallery-grid">
        <!-- Images will be populated dynamically -->
      </div>

      <!-- Image Preview Panel (shown when image selected) -->
      <div class="image-preview-section" id="image-preview-section" style="display: none;">
        <h3>Preview: <span id="selected-image-name"></span></h3>

        <div class="image-preview-container">
          <img id="image-preview" alt="Monochrome Preview" />
        </div>

        <div class="image-controls">
          <div class="control-group">
            <label>Rotation:</label>
            <div class="rotation-buttons">
              <button onclick="setRotation(0)" id="rot-0" class="active">0째</button>
              <button onclick="setRotation(90)" id="rot-90">90째</button>
              <button onclick="setRotation(180)" id="rot-180">180째</button>
              <button onclick="setRotation(270)" id="rot-270">270째</button>
            </div>
          </div>

          <div class="control-group">
            <label>Fit Mode:</label>
            <div class="fit-mode-buttons">
              <button onclick="setFitMode('fit')" id="fit-fit" class="active">Fit (letterbox)</button>
              <button onclick="setFitMode('fill')" id="fit-fill">Fill (crop)</button>
            </div>
          </div>
        </div>

        <div class="image-info" id="image-info"></div>

        <div class="image-actions">
          <button class="btn-primary" onclick="sendImageToDisplay()">Send to Display</button>
          <button class="btn-danger" onclick="deleteSelectedImage()">Delete Image</button>
        </div>
      </div>

      <!-- Upload Section -->
      <div class="upload-section">
        <form class="upload-form" id="gallery-upload-form" onsubmit="uploadNewImage(event)">
          <input type="file" name="file" accept="image/*" required />
          <button type="submit">Upload Image</button>
        </form>
      </div>
    </div>

    <script>
      let currentMode = 'manual';
      let availableLayouts = [];

      async function refreshStatus() {
        try {
          const res = await fetch("/api/status");
          const data = await res.json();

          // Update mode buttons
          currentMode = data.mode || 'manual';
          document.getElementById('btn-manual').classList.toggle('active', currentMode === 'manual');
          document.getElementById('btn-auto').classList.toggle('active', currentMode === 'auto_rotate');

          // Update current layout
          const layoutEl = document.getElementById('current-layout');
          layoutEl.textContent = data.current_layout || 'None';

          // Update last updated
          const updatedEl = document.getElementById('last-updated');
          if (data.last_updated) {
            const date = new Date(data.last_updated);
            updatedEl.textContent = 'Updated: ' + date.toLocaleTimeString();
          } else {
            updatedEl.textContent = '';
          }

          // Update available layouts
          availableLayouts = data.available_layouts || [];
          renderLayoutsGrid();

          // Update providers
          renderProviders(data.providers || []);

          // Update preview image
          const previewContainer = document.getElementById('preview-container');
          previewContainer.innerHTML = `
            <img class="preview" src="/api/preview?t=${Date.now()}" alt="Preview"
                 onerror="this.parentElement.innerHTML='<em>No preview yet</em>'" />
          `;
        } catch (e) {
          console.error('Failed to refresh status:', e);
        }
      }

      function renderLayoutsGrid() {
        const grid = document.getElementById('layouts-grid');

        // Define layout descriptions
        const descriptions = {
          'composite_hub': 'All-in-one view with weather, calendar, Strava, and tasks.',
          'strava_dashboard': 'Weekly running stats with mileage chart.',
          'daily_rundown': 'Calendar events with weather overview.',
          'week_view': 'Apple Calendar style week view with hourly grid.',
          'weather_view': 'Full weather display with hourly and 5-day forecast.',
        };

        grid.innerHTML = availableLayouts.map(layout => `
          <div class="card">
            <h3>${formatLayoutName(layout)}</h3>
            <p>${descriptions[layout] || 'Custom layout'}</p>
            <button onclick="setLayout('${layout}')">Send to Display</button>
          </div>
        `).join('');
      }

      function formatLayoutName(name) {
        return name.split('_').map(word =>
          word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
      }

      function renderProviders(providers) {
        const list = document.getElementById('providers-list');
        list.innerHTML = providers.map(p => {
          const statusClass = !p.enabled ? 'disabled' : (p.error ? 'error' : 'enabled');
          const dotClass = !p.enabled ? '' : (p.error ? 'error' : 'ok');

          return `
            <div class="provider-badge ${statusClass}">
              <span class="provider-status ${dotClass}"></span>
              <span>${formatLayoutName(p.name)}</span>
              ${p.enabled ? `<button class="provider-refresh" onclick="refreshProvider('${p.name}')">Refresh</button>` : ''}
            </div>
          `;
        }).join('');
      }

      async function setMode(mode) {
        try {
          await fetch('/api/mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode })
          });
          await refreshStatus();
        } catch (e) {
          console.error('Failed to set mode:', e);
        }
      }

      async function setLayout(layout) {
        try {
          await fetch('/api/display', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ layout, options: {} })
          });
          await refreshStatus();
        } catch (e) {
          console.error('Failed to set layout:', e);
        }
      }

      async function refreshProvider(name) {
        try {
          await fetch(`/api/refresh/${name}`, { method: 'POST' });
          // Wait a moment for data to be fetched
          setTimeout(refreshStatus, 1000);
        } catch (e) {
          console.error('Failed to refresh provider:', e);
        }
      }

      // ========================================
      // Image Gallery Functions
      // ========================================

      let galleryImages = [];
      let selectedImage = null;
      let currentRotation = 0;
      let currentFitMode = 'fit';

      async function loadGallery() {
        try {
          const res = await fetch('/api/images');
          const data = await res.json();
          galleryImages = data.images || [];
          renderGallery();
        } catch (e) {
          console.error('Failed to load gallery:', e);
        }
      }

      function renderGallery() {
        const grid = document.getElementById('gallery-grid');

        if (galleryImages.length === 0) {
          grid.innerHTML = '<div class="gallery-empty">No images uploaded yet. Upload an image to get started.</div>';
          return;
        }

        grid.innerHTML = galleryImages.map(img => `
          <div class="gallery-item ${selectedImage && selectedImage.filename === img.filename ? 'selected' : ''}"
               onclick="selectImage('${img.filename}')"
               title="${img.filename}">
            <img src="/api/images/${encodeURIComponent(img.filename)}/thumbnail"
                 alt="${img.filename}"
                 onerror="this.src='/api/images/${encodeURIComponent(img.filename)}'" />
          </div>
        `).join('');
      }

      async function selectImage(filename) {
        selectedImage = galleryImages.find(img => img.filename === filename);
        if (!selectedImage) return;

        // Reset controls
        currentRotation = 0;
        currentFitMode = 'fit';

        // Update UI
        document.getElementById('selected-image-name').textContent = filename;
        document.getElementById('image-preview-section').style.display = 'block';

        // Update button states
        updateRotationButtons();
        updateFitModeButtons();

        // Show image info
        const info = document.getElementById('image-info');
        const sizeKB = Math.round(selectedImage.size_bytes / 1024);
        info.textContent = `${selectedImage.width} x ${selectedImage.height} px | ${sizeKB} KB`;

        // Update gallery selection
        renderGallery();

        // Load preview
        await updatePreview();
      }

      async function updatePreview() {
        if (!selectedImage) return;

        const previewImg = document.getElementById('image-preview');
        previewImg.style.opacity = '0.5';

        try {
          const res = await fetch('/api/images/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image_path: selectedImage.path,
              rotation: currentRotation,
              fit_mode: currentFitMode
            })
          });

          if (res.ok) {
            const blob = await res.blob();
            previewImg.src = URL.createObjectURL(blob);
          }
        } catch (e) {
          console.error('Failed to generate preview:', e);
        } finally {
          previewImg.style.opacity = '1';
        }
      }

      function setRotation(degrees) {
        currentRotation = degrees;
        updateRotationButtons();
        updatePreview();
      }

      function updateRotationButtons() {
        [0, 90, 180, 270].forEach(deg => {
          const btn = document.getElementById(`rot-${deg}`);
          btn.classList.toggle('active', deg === currentRotation);
        });
      }

      function setFitMode(mode) {
        currentFitMode = mode;
        updateFitModeButtons();
        updatePreview();
      }

      function updateFitModeButtons() {
        document.getElementById('fit-fit').classList.toggle('active', currentFitMode === 'fit');
        document.getElementById('fit-fill').classList.toggle('active', currentFitMode === 'fill');
      }

      async function sendImageToDisplay() {
        if (!selectedImage) return;

        try {
          const res = await fetch('/api/images/display', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image_path: selectedImage.path,
              rotation: currentRotation,
              fit_mode: currentFitMode
            })
          });

          if (res.ok) {
            await refreshStatus();
            alert('Image sent to display!');
          } else {
            const err = await res.json();
            alert('Failed to send image: ' + (err.detail || 'Unknown error'));
          }
        } catch (e) {
          console.error('Failed to send image to display:', e);
          alert('Failed to send image to display');
        }
      }

      async function deleteSelectedImage() {
        if (!selectedImage) return;

        if (!confirm(`Delete "${selectedImage.filename}"?`)) return;

        try {
          const res = await fetch(`/api/images/${encodeURIComponent(selectedImage.filename)}`, {
            method: 'DELETE'
          });

          if (res.ok) {
            selectedImage = null;
            document.getElementById('image-preview-section').style.display = 'none';
            await loadGallery();
          } else {
            alert('Failed to delete image');
          }
        } catch (e) {
          console.error('Failed to delete image:', e);
          alert('Failed to delete image');
        }
      }

      async function uploadNewImage(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        try {
          const res = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });

          if (res.ok) {
            const data = await res.json();
            form.reset();
            await loadGallery();
            // Auto-select the newly uploaded image
            const filename = data.image_path.split('/').pop();
            selectImage(filename);
          } else {
            alert('Failed to upload image');
          }
        } catch (e) {
          console.error('Failed to upload image:', e);
          alert('Failed to upload image');
        }
      }

      function togglePhotoAutoRotate() {
        const checkbox = document.getElementById('photo-auto-rotate');
        // TODO: Implement auto-rotate mode for photos
        // This would require backend support to cycle through uploaded images
        if (checkbox.checked) {
          alert('Photo auto-rotate will cycle through your uploaded images on the display. (Feature coming soon!)');
          checkbox.checked = false;
        }
      }

      // Initial load
      refreshStatus();
      loadGallery();

      // Refresh every 15 seconds
      setInterval(refreshStatus, 15000);
    </script>
  </body>
</html>
