<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sensor History - E-Ink Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #fafafa;
      }
      h1 {
        margin-bottom: 0.25rem;
        color: #222;
      }
      h2 {
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        margin-top: 24px;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
      }
      .nav-link {
        color: #0066cc;
        text-decoration: none;
      }
      .nav-link:hover {
        text-decoration: underline;
      }
      .current-readings {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .reading-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
      }
      .reading-card.stale {
        border-color: #f0ad4e;
        background: #fffdf5;
      }
      .reading-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
      }
      .reading-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 4px;
      }
      .reading-meta {
        font-size: 0.8rem;
        color: #999;
        margin-top: 8px;
      }
      .stats-row {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 12px;
        font-size: 0.85rem;
        color: #666;
      }
      .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .stat-value {
        font-weight: 600;
        color: #333;
      }
      .chart-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
      }
      .time-selector {
        display: flex;
        gap: 8px;
      }
      .time-selector button {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .time-selector button:hover {
        background: #f5f5f5;
      }
      .time-selector button.active {
        background: #333;
        color: white;
        border-color: #333;
      }
      .chart-wrapper {
        position: relative;
        height: 300px;
      }
      .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .sensor-info {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 16px;
      }

      /* Advanced View Styles */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 32px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #ddd;
      }
      .section-header h2 {
        margin: 0;
        border: none;
        padding: 0;
      }
      .toggle-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .toggle-btn:hover {
        background: #f5f5f5;
      }
      .toggle-btn.active {
        background: #333;
        color: white;
        border-color: #333;
      }
      .advanced-section {
        display: none;
      }
      .advanced-section.visible {
        display: block;
      }
      .data-table-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }
      .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #f9f9f9;
        border-bottom: 1px solid #ddd;
        flex-wrap: wrap;
        gap: 12px;
      }
      .table-controls-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .table-controls select {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85rem;
      }
      .table-controls label {
        font-size: 0.85rem;
        color: #666;
      }
      .record-count {
        font-size: 0.85rem;
        color: #666;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      .data-table th {
        background: #f5f5f5;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
        position: sticky;
        top: 0;
      }
      .data-table td {
        padding: 10px 16px;
        border-bottom: 1px solid #eee;
        color: #444;
      }
      .data-table tr:hover {
        background: #fafafa;
      }
      .data-table .id-col {
        color: #999;
        font-family: monospace;
        font-size: 0.8rem;
      }
      .data-table .timestamp-col {
        white-space: nowrap;
      }
      .data-table .sensor-col {
        font-family: monospace;
        font-size: 0.85rem;
      }
      .data-table .value-col {
        font-weight: 500;
        text-align: right;
      }
      .data-table .temp-col {
        color: #e74c3c;
      }
      .data-table .humidity-col {
        color: #3498db;
      }
      .table-scroll {
        max-height: 500px;
        overflow-y: auto;
      }
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #f9f9f9;
        border-top: 1px solid #ddd;
      }
      .pagination button {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .pagination button:hover:not(:disabled) {
        background: #f5f5f5;
      }
      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pagination .page-info {
        font-size: 0.85rem;
        color: #666;
        padding: 0 12px;
      }
      .export-btn {
        padding: 6px 12px;
        border: 1px solid #4caf50;
        background: white;
        color: #4caf50;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .export-btn:hover {
        background: #4caf50;
        color: white;
      }
      .db-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }
      .db-stat-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        text-align: center;
      }
      .db-stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
      }
      .db-stat-label {
        font-size: 0.8rem;
        color: #666;
        margin-top: 4px;
      }

      /* Weather Forecast Styles */
      .forecast-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .forecast-main {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .forecast-icon {
        font-size: 4rem;
        line-height: 1;
      }
      .forecast-details {
        flex: 1;
      }
      .forecast-summary {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }
      .forecast-description {
        font-size: 0.95rem;
        color: #666;
        line-height: 1.5;
      }
      .forecast-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        padding-top: 16px;
        border-top: 1px solid #eee;
      }
      .forecast-metric {
        text-align: center;
      }
      .metric-label {
        display: block;
        font-size: 0.8rem;
        color: #888;
        margin-bottom: 4px;
      }
      .metric-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
      }
      .forecast-confidence {
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 12px;
        background: #e8f5e9;
        color: #2e7d32;
      }
      .forecast-confidence.low {
        background: #fff3e0;
        color: #e65100;
      }
      .pressure-rising { color: #2e7d32; }
      .pressure-falling { color: #c62828; }
      .pressure-steady { color: #666; }

      /* Pressure card colors */
      .reading-card.pressure-high {
        border-color: #81c784;
        background: linear-gradient(135deg, #fff 0%, #e8f5e9 100%);
      }
      .reading-card.pressure-low {
        border-color: #e57373;
        background: linear-gradient(135deg, #fff 0%, #ffebee 100%);
      }

      /* Data table pressure/dewpoint columns */
      .data-table .pressure-col {
        color: #9c27b0;
      }
      .data-table .dewpoint-col {
        color: #00897b;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1>Indoor Sensor History</h1>
        <a href="/" class="nav-link">&larr; Back to Dashboard</a>
      </div>
      <div class="sensor-info" id="sensor-info">
        Loading...
      </div>
    </div>

    <div class="current-readings" id="current-readings">
      <div class="reading-card">
        <div class="reading-value" id="current-temp">--</div>
        <div class="reading-label">Temperature</div>
        <div class="stats-row">
          <div class="stat">
            <span class="stat-value" id="temp-min">--</span>
            <span>Min</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="temp-max">--</span>
            <span>Max</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="temp-avg">--</span>
            <span>Avg</span>
          </div>
        </div>
      </div>
      <div class="reading-card">
        <div class="reading-value" id="current-humidity">--</div>
        <div class="reading-label">Humidity</div>
        <div class="stats-row">
          <div class="stat">
            <span class="stat-value" id="hum-min">--</span>
            <span>Min</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="hum-max">--</span>
            <span>Max</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="hum-avg">--</span>
            <span>Avg</span>
          </div>
        </div>
      </div>
      <div class="reading-card" id="pressure-card" style="display: none;">
        <div class="reading-value" id="current-pressure">--</div>
        <div class="reading-label">Pressure</div>
        <div class="stats-row">
          <div class="stat">
            <span class="stat-value" id="pressure-min">--</span>
            <span>Min</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="pressure-max">--</span>
            <span>Max</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="pressure-trend">--</span>
            <span>Trend</span>
          </div>
        </div>
      </div>
      <div class="reading-card" id="dewpoint-card" style="display: none;">
        <div class="reading-value" id="current-dewpoint">--</div>
        <div class="reading-label">Dew Point</div>
        <div class="reading-meta" id="dewpoint-comfort">--</div>
      </div>
    </div>

    <!-- Weather Forecast Card -->
    <div class="chart-container" id="forecast-section" style="display: none;">
      <div class="chart-header">
        <span class="chart-title">Weather Forecast</span>
        <span class="forecast-confidence" id="forecast-confidence"></span>
      </div>
      <div class="forecast-content">
        <div class="forecast-main">
          <span class="forecast-icon" id="forecast-icon">--</span>
          <div class="forecast-details">
            <div class="forecast-summary" id="forecast-summary">Analyzing pressure trends...</div>
            <div class="forecast-description" id="forecast-description"></div>
          </div>
        </div>
        <div class="forecast-metrics">
          <div class="forecast-metric">
            <span class="metric-label">3hr Change</span>
            <span class="metric-value" id="pressure-change-3h">--</span>
          </div>
          <div class="forecast-metric">
            <span class="metric-label">Pressure State</span>
            <span class="metric-value" id="pressure-state">--</span>
          </div>
          <div class="forecast-metric">
            <span class="metric-label">Trend</span>
            <span class="metric-value" id="pressure-direction">--</span>
          </div>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Temperature History</span>
        <div class="time-selector">
          <button onclick="setTimeRange(1)" id="btn-1h">1H</button>
          <button onclick="setTimeRange(6)" id="btn-6h">6H</button>
          <button onclick="setTimeRange(24)" class="active" id="btn-24h">24H</button>
          <button onclick="setTimeRange(72)" id="btn-72h">3D</button>
          <button onclick="setTimeRange(168)" id="btn-168h">7D</button>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="tempChart"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <span class="chart-title">Humidity History</span>
      </div>
      <div class="chart-wrapper">
        <canvas id="humidityChart"></canvas>
      </div>
    </div>

    <!-- Pressure Chart (BME280 only) -->
    <div class="chart-container" id="pressure-chart-container" style="display: none;">
      <div class="chart-header">
        <span class="chart-title">Barometric Pressure History</span>
      </div>
      <div class="chart-wrapper">
        <canvas id="pressureChart"></canvas>
      </div>
    </div>

    <!-- Dew Point Chart (BME280 only) -->
    <div class="chart-container" id="dewpoint-chart-container" style="display: none;">
      <div class="chart-header">
        <span class="chart-title">Dew Point History</span>
      </div>
      <div class="chart-wrapper">
        <canvas id="dewpointChart"></canvas>
      </div>
    </div>

    <!-- Advanced Database View -->
    <div class="section-header">
      <h2>Database Records</h2>
      <button class="toggle-btn" id="toggle-advanced" onclick="toggleAdvancedView()">
        <span id="toggle-icon">+</span> Show Raw Data
      </button>
    </div>

    <div class="advanced-section" id="advanced-section">
      <!-- Database Stats -->
      <div class="db-stats" id="db-stats">
        <div class="db-stat-card">
          <div class="db-stat-value" id="total-records">--</div>
          <div class="db-stat-label">Total Records</div>
        </div>
        <div class="db-stat-card">
          <div class="db-stat-value" id="sensor-count">--</div>
          <div class="db-stat-label">Sensors</div>
        </div>
        <div class="db-stat-card">
          <div class="db-stat-value" id="oldest-record">--</div>
          <div class="db-stat-label">Oldest Record</div>
        </div>
        <div class="db-stat-card">
          <div class="db-stat-value" id="newest-record">--</div>
          <div class="db-stat-label">Newest Record</div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="data-table-container">
        <div class="table-controls">
          <div class="table-controls-left">
            <label>
              Time Range:
              <select id="table-hours" onchange="fetchTableData()">
                <option value="1">Last 1 hour</option>
                <option value="6">Last 6 hours</option>
                <option value="24" selected>Last 24 hours</option>
                <option value="72">Last 3 days</option>
                <option value="168">Last 7 days</option>
                <option value="720">Last 30 days</option>
              </select>
            </label>
            <label>
              Rows per page:
              <select id="rows-per-page" onchange="changePageSize()">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="250">250</option>
              </select>
            </label>
          </div>
          <div>
            <span class="record-count" id="record-count">Loading...</span>
            <button class="export-btn" onclick="exportCSV()">Export CSV</button>
          </div>
        </div>

        <div class="table-scroll">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Timestamp</th>
                <th>Sensor ID</th>
                <th style="text-align: right">Temp (F)</th>
                <th style="text-align: right">Humidity (%)</th>
                <th style="text-align: right">Pressure (hPa)</th>
                <th style="text-align: right">Dew Pt (F)</th>
              </tr>
            </thead>
            <tbody id="table-body">
              <tr><td colspan="7" style="text-align: center; padding: 20px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="pagination">
          <button onclick="changePage(-1)" id="prev-btn" disabled>Previous</button>
          <span class="page-info" id="page-info">Page 1</span>
          <button onclick="changePage(1)" id="next-btn">Next</button>
        </div>
      </div>
    </div>

    <script>
      let currentHours = 24;
      let tempChart = null;
      let humidityChart = null;
      let pressureChart = null;
      let dewpointChart = null;
      let hasBME280 = false;  // Track if we have BME280 data

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index',
        },
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            callbacks: {
              title: function(context) {
                const date = new Date(context[0].parsed.x);
                return date.toLocaleString();
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              displayFormats: {
                hour: 'ha',
                day: 'MMM d',
              }
            },
            grid: {
              display: false,
            },
            ticks: {
              maxTicksLimit: 8,
            }
          },
          y: {
            grid: {
              color: '#f0f0f0',
            },
            ticks: {
              padding: 8,
            }
          }
        }
      };

      function initCharts() {
        const tempCtx = document.getElementById('tempChart').getContext('2d');
        tempChart = new Chart(tempCtx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Temperature (Â°F)',
              data: [],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 5,
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                ...chartOptions.scales.y,
                title: {
                  display: true,
                  text: 'Â°F'
                }
              }
            }
          }
        });

        const humCtx = document.getElementById('humidityChart').getContext('2d');
        humidityChart = new Chart(humCtx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Humidity (%)',
              data: [],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 5,
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                ...chartOptions.scales.y,
                title: {
                  display: true,
                  text: '%'
                },
                min: 0,
                max: 100,
              }
            }
          }
        });

        // Pressure chart (BME280)
        const pressCtx = document.getElementById('pressureChart').getContext('2d');
        pressureChart = new Chart(pressCtx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Pressure (hPa)',
              data: [],
              borderColor: '#9c27b0',
              backgroundColor: 'rgba(156, 39, 176, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 5,
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                ...chartOptions.scales.y,
                title: {
                  display: true,
                  text: 'hPa'
                }
              }
            }
          }
        });

        // Dew Point chart (BME280)
        const dewCtx = document.getElementById('dewpointChart').getContext('2d');
        dewpointChart = new Chart(dewCtx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Dew Point (Â°F)',
              data: [],
              borderColor: '#00897b',
              backgroundColor: 'rgba(0, 137, 123, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 5,
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              y: {
                ...chartOptions.scales.y,
                title: {
                  display: true,
                  text: 'Â°F'
                }
              }
            }
          }
        });
      }

      async function fetchCurrentData() {
        try {
          const res = await fetch('/api/sensor-data');
          const data = await res.json();

          if (!data.available) {
            document.getElementById('sensor-info').textContent = 'No sensor data available';
            return;
          }

          // Update current readings
          document.getElementById('current-temp').textContent = `${data.temperature_f}Â°F`;
          document.getElementById('current-humidity').textContent = `${data.humidity}%`;

          // Update sensor info
          const ageText = data.age_minutes === 0 ? 'just now' :
                         data.age_minutes === 1 ? '1 min ago' :
                         `${data.age_minutes} min ago`;

          let sensorInfo = `Sensor: ${data.sensor_id} | Last update: ${ageText}`;
          if (data.uptime_s !== null && data.uptime_s !== undefined) {
            const uptimeStr = formatUptime(data.uptime_s);
            sensorInfo += ` | Uptime: ${uptimeStr}`;
          }
          if (data.boot_count !== null && data.boot_count !== undefined) {
            sensorInfo += ` | Boots: ${data.boot_count}`;
          }
          document.getElementById('sensor-info').textContent = sensorInfo;

          // Mark as stale if needed
          const cards = document.querySelectorAll('.reading-card');
          cards.forEach(card => {
            card.classList.toggle('stale', data.is_stale);
          });

          // BME280 specific fields
          if (data.pressure_hpa !== null && data.pressure_hpa !== undefined) {
            hasBME280 = true;

            // Show BME280 cards and charts
            document.getElementById('pressure-card').style.display = 'block';
            document.getElementById('dewpoint-card').style.display = 'block';
            document.getElementById('forecast-section').style.display = 'block';
            document.getElementById('pressure-chart-container').style.display = 'block';
            document.getElementById('dewpoint-chart-container').style.display = 'block';

            // Update pressure
            document.getElementById('current-pressure').textContent = `${data.pressure_hpa} hPa`;

            // Color code pressure card
            const pressureCard = document.getElementById('pressure-card');
            pressureCard.classList.remove('pressure-high', 'pressure-low');
            if (data.pressure_hpa > 1020) {
              pressureCard.classList.add('pressure-high');
            } else if (data.pressure_hpa < 1000) {
              pressureCard.classList.add('pressure-low');
            }
          }

          // Dew point
          if (data.dew_point_f !== null && data.dew_point_f !== undefined) {
            document.getElementById('current-dewpoint').textContent = `${data.dew_point_f}Â°F`;
            document.getElementById('dewpoint-comfort').textContent = getDewPointComfort(data.dew_point_f);
          }

        } catch (e) {
          console.error('Failed to fetch current data:', e);
        }
      }

      function formatUptime(seconds) {
        if (seconds >= 86400) {
          const days = Math.floor(seconds / 86400);
          const hours = Math.floor((seconds % 86400) / 3600);
          return `${days}d ${hours}h`;
        } else if (seconds >= 3600) {
          const hours = Math.floor(seconds / 3600);
          const mins = Math.floor((seconds % 3600) / 60);
          return `${hours}h ${mins}m`;
        } else {
          return `${Math.floor(seconds / 60)}m`;
        }
      }

      function getDewPointComfort(dewF) {
        // Dew point comfort levels in Fahrenheit
        if (dewF < 50) return 'Dry & comfortable';
        if (dewF < 55) return 'Comfortable';
        if (dewF < 60) return 'OK for most';
        if (dewF < 65) return 'Slightly humid';
        if (dewF < 70) return 'Humid';
        if (dewF < 75) return 'Very humid';
        return 'Oppressive';
      }

      async function fetchHistory() {
        try {
          const res = await fetch(`/api/sensor-data/history?hours=${currentHours}`);
          const data = await res.json();

          if (!data.readings || data.readings.length === 0) {
            return;
          }

          // Update stats
          const stats = data.stats;
          if (stats && stats.reading_count > 0) {
            const tempStats = stats.temperature;
            const humStats = stats.humidity;

            // Convert to Fahrenheit for display
            const toF = (c) => c !== null ? ((c * 9/5) + 32).toFixed(1) : '--';

            document.getElementById('temp-min').textContent = `${toF(tempStats.min)}Â°`;
            document.getElementById('temp-max').textContent = `${toF(tempStats.max)}Â°`;
            document.getElementById('temp-avg').textContent = `${toF(tempStats.avg)}Â°`;

            document.getElementById('hum-min').textContent = `${humStats.min}%`;
            document.getElementById('hum-max').textContent = `${humStats.max}%`;
            document.getElementById('hum-avg').textContent = `${humStats.avg?.toFixed(1)}%`;

            // Pressure stats (BME280)
            if (stats.pressure) {
              document.getElementById('pressure-min').textContent = `${stats.pressure.min}`;
              document.getElementById('pressure-max').textContent = `${stats.pressure.max}`;
            }
          }

          // Prepare chart data (readings are in DESC order, reverse for chart)
          const readings = data.readings.reverse();

          const tempData = readings.map(r => ({
            x: new Date(r.timestamp),
            y: (r.temperature_c * 9/5) + 32  // Convert to Fahrenheit
          }));

          const humData = readings.map(r => ({
            x: new Date(r.timestamp),
            y: r.humidity
          }));

          // Update temp and humidity charts
          tempChart.data.datasets[0].data = tempData;
          tempChart.update('none');

          humidityChart.data.datasets[0].data = humData;
          humidityChart.update('none');

          // Pressure and dew point charts (BME280)
          const pressureReadings = readings.filter(r => r.pressure_hpa !== null && r.pressure_hpa !== undefined);

          if (pressureReadings.length > 0) {
            hasBME280 = true;

            const pressureData = pressureReadings.map(r => ({
              x: new Date(r.timestamp),
              y: r.pressure_hpa
            }));

            const dewpointData = readings
              .filter(r => r.dew_point_c !== null && r.dew_point_c !== undefined)
              .map(r => ({
                x: new Date(r.timestamp),
                y: (r.dew_point_c * 9/5) + 32
              }));

            pressureChart.data.datasets[0].data = pressureData;
            pressureChart.update('none');

            if (dewpointData.length > 0) {
              dewpointChart.data.datasets[0].data = dewpointData;
              dewpointChart.update('none');
            }

            // Analyze pressure trend for weather forecast
            analyzePressureTrend(pressureReadings);
          }

        } catch (e) {
          console.error('Failed to fetch history:', e);
        }
      }

      function analyzePressureTrend(readings) {
        if (readings.length < 2) {
          document.getElementById('forecast-summary').textContent = 'Insufficient data';
          return;
        }

        const now = new Date();
        const threeHoursAgo = new Date(now - 3 * 60 * 60 * 1000);

        // Get readings from last 3 hours
        const recentReadings = readings.filter(r => new Date(r.timestamp) >= threeHoursAgo);

        if (recentReadings.length < 2) {
          document.getElementById('forecast-summary').textContent = 'Need more data for forecast';
          document.getElementById('forecast-confidence').textContent = 'Low confidence';
          document.getElementById('forecast-confidence').classList.add('low');
          return;
        }

        // Calculate pressure change over 3 hours
        const oldestRecent = recentReadings[0];
        const newestRecent = recentReadings[recentReadings.length - 1];
        const pressureChange = newestRecent.pressure_hpa - oldestRecent.pressure_hpa;
        const currentPressure = newestRecent.pressure_hpa;

        // Update trend display
        const trendEl = document.getElementById('pressure-trend');
        const directionEl = document.getElementById('pressure-direction');
        const changeEl = document.getElementById('pressure-change-3h');
        const stateEl = document.getElementById('pressure-state');

        const changeStr = pressureChange >= 0 ? `+${pressureChange.toFixed(1)}` : pressureChange.toFixed(1);
        changeEl.textContent = `${changeStr} hPa`;

        // Pressure state classification
        if (currentPressure > 1025) {
          stateEl.textContent = 'Very High';
        } else if (currentPressure > 1015) {
          stateEl.textContent = 'High';
        } else if (currentPressure > 1005) {
          stateEl.textContent = 'Normal';
        } else if (currentPressure > 995) {
          stateEl.textContent = 'Low';
        } else {
          stateEl.textContent = 'Very Low';
        }

        // Weather prediction based on pressure trend
        let icon, summary, description, trend, trendClass;

        if (pressureChange < -2) {
          // Rapidly falling
          icon = 'â›ˆï¸';
          summary = 'Storms Likely';
          description = 'Barometric pressure is dropping rapidly. Expect deteriorating conditions with possible rain or storms within 6-12 hours.';
          trend = 'â†“â†“ Falling fast';
          trendClass = 'pressure-falling';
        } else if (pressureChange < -1) {
          // Falling
          icon = 'ðŸŒ§ï¸';
          summary = 'Rain Possible';
          description = 'Pressure is falling steadily. Weather is changing - clouds and possible precipitation expected within 12-24 hours.';
          trend = 'â†“ Falling';
          trendClass = 'pressure-falling';
        } else if (pressureChange < -0.5) {
          // Slowly falling
          icon = 'ðŸŒ¥ï¸';
          summary = 'Change Coming';
          description = 'Slight pressure drop detected. Current conditions may slowly deteriorate over the next day.';
          trend = 'â†˜ Slight drop';
          trendClass = 'pressure-falling';
        } else if (pressureChange > 2) {
          // Rapidly rising
          icon = 'â˜€ï¸';
          summary = 'Clear & Fair';
          description = 'Pressure rising quickly. Expect clearing skies and fair weather. Great conditions ahead!';
          trend = 'â†‘â†‘ Rising fast';
          trendClass = 'pressure-rising';
        } else if (pressureChange > 1) {
          // Rising
          icon = 'ðŸŒ¤ï¸';
          summary = 'Improving';
          description = 'Pressure is rising steadily. Weather is improving - expect clearer skies and drier conditions.';
          trend = 'â†‘ Rising';
          trendClass = 'pressure-rising';
        } else if (pressureChange > 0.5) {
          // Slowly rising
          icon = 'â›…';
          summary = 'Gradual Improvement';
          description = 'Slight pressure increase. Conditions should slowly improve over the next day.';
          trend = 'â†— Slight rise';
          trendClass = 'pressure-rising';
        } else {
          // Steady
          icon = 'âž¡ï¸';
          summary = 'Stable Conditions';
          description = 'Pressure is steady. Current weather conditions are likely to continue for the next 12-24 hours.';
          trend = 'â†’ Steady';
          trendClass = 'pressure-steady';
        }

        // Additional context based on absolute pressure
        if (currentPressure > 1020 && pressureChange >= -0.5) {
          icon = 'â˜€ï¸';
          if (pressureChange > 0.5) {
            summary = 'High Pressure - Fair';
          } else {
            summary = 'High Pressure - Stable';
          }
          description += ' High pressure system in place - generally means fair weather.';
        } else if (currentPressure < 1000 && pressureChange <= 0.5) {
          icon = 'ðŸŒ§ï¸';
          if (pressureChange < -0.5) {
            summary = 'Low Pressure - Unsettled';
          } else {
            summary = 'Low Pressure';
          }
          description += ' Low pressure system - typically associated with clouds and precipitation.';
        }

        // Update UI
        document.getElementById('forecast-icon').textContent = icon;
        document.getElementById('forecast-summary').textContent = summary;
        document.getElementById('forecast-description').textContent = description;
        document.getElementById('pressure-direction').textContent = trend;

        trendEl.textContent = trend.charAt(0);
        trendEl.className = 'stat-value ' + trendClass;
        directionEl.className = 'metric-value ' + trendClass;

        // Confidence based on data quantity
        const confidence = recentReadings.length >= 10 ? 'High confidence' : 'Moderate confidence';
        const confEl = document.getElementById('forecast-confidence');
        confEl.textContent = confidence;
        confEl.classList.remove('low');
        if (recentReadings.length < 5) {
          confEl.textContent = 'Low confidence';
          confEl.classList.add('low');
        }
      }

      function setTimeRange(hours) {
        currentHours = hours;

        // Update button states
        document.querySelectorAll('.time-selector button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.getElementById(`btn-${hours}h`).classList.add('active');

        fetchHistory();
      }

      // Initialize
      initCharts();
      fetchCurrentData();
      fetchHistory();

      // Refresh current data every 30 seconds
      setInterval(fetchCurrentData, 30000);

      // Refresh history every 2 minutes
      setInterval(fetchHistory, 120000);

      // ============================================
      // Advanced Database View
      // ============================================

      let advancedVisible = false;
      let allTableData = [];
      let currentPage = 1;
      let rowsPerPage = 50;

      function toggleAdvancedView() {
        advancedVisible = !advancedVisible;
        const section = document.getElementById('advanced-section');
        const btn = document.getElementById('toggle-advanced');
        const icon = document.getElementById('toggle-icon');

        if (advancedVisible) {
          section.classList.add('visible');
          btn.classList.add('active');
          icon.textContent = '-';
          btn.innerHTML = '<span id="toggle-icon">-</span> Hide Raw Data';
          fetchTableData();
        } else {
          section.classList.remove('visible');
          btn.classList.remove('active');
          icon.textContent = '+';
          btn.innerHTML = '<span id="toggle-icon">+</span> Show Raw Data';
        }
      }

      async function fetchTableData() {
        const hours = parseInt(document.getElementById('table-hours').value);

        try {
          const res = await fetch(`/api/sensor-data/history?hours=${hours}`);
          const data = await res.json();

          if (!data.readings) {
            document.getElementById('table-body').innerHTML =
              '<tr><td colspan="6" style="text-align: center; padding: 20px;">No data available</td></tr>';
            return;
          }

          // Store all data (already in DESC order - newest first)
          allTableData = data.readings;

          // Update stats
          updateDbStats(data);

          // Reset to first page
          currentPage = 1;
          renderTable();

        } catch (e) {
          console.error('Failed to fetch table data:', e);
          document.getElementById('table-body').innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Error loading data</td></tr>';
        }
      }

      function updateDbStats(data) {
        const readings = data.readings || [];
        const stats = data.stats || {};

        document.getElementById('total-records').textContent = readings.length.toLocaleString();
        document.getElementById('record-count').textContent = `${readings.length.toLocaleString()} records`;

        // Get unique sensors
        const sensors = new Set(readings.map(r => r.sensor_id));
        document.getElementById('sensor-count').textContent = sensors.size;

        // Oldest and newest (readings are DESC, so last is oldest)
        if (readings.length > 0) {
          const newest = new Date(readings[0].timestamp);
          const oldest = new Date(readings[readings.length - 1].timestamp);

          document.getElementById('newest-record').textContent = formatShortDate(newest);
          document.getElementById('oldest-record').textContent = formatShortDate(oldest);
        } else {
          document.getElementById('newest-record').textContent = '--';
          document.getElementById('oldest-record').textContent = '--';
        }
      }

      function formatShortDate(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;

        return date.toLocaleDateString();
      }

      function renderTable() {
        const tbody = document.getElementById('table-body');
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = startIdx + rowsPerPage;
        const pageData = allTableData.slice(startIdx, endIdx);

        if (pageData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No data</td></tr>';
          return;
        }

        tbody.innerHTML = pageData.map(row => {
          const tempF = ((row.temperature_c * 9/5) + 32).toFixed(1);
          const timestamp = new Date(row.timestamp);
          const timeStr = timestamp.toLocaleString();

          // Handle optional BME280 fields
          const pressure = row.pressure_hpa !== null && row.pressure_hpa !== undefined
            ? row.pressure_hpa.toFixed(1)
            : '--';
          const dewF = row.dew_point_c !== null && row.dew_point_c !== undefined
            ? ((row.dew_point_c * 9/5) + 32).toFixed(1)
            : '--';

          return `
            <tr>
              <td class="id-col">${row.id}</td>
              <td class="timestamp-col">${timeStr}</td>
              <td class="sensor-col">${row.sensor_id}</td>
              <td class="value-col temp-col">${tempF}</td>
              <td class="value-col humidity-col">${row.humidity.toFixed(1)}</td>
              <td class="value-col pressure-col">${pressure}</td>
              <td class="value-col dewpoint-col">${dewF}</td>
            </tr>
          `;
        }).join('');

        // Update pagination
        const totalPages = Math.ceil(allTableData.length / rowsPerPage);
        document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prev-btn').disabled = currentPage <= 1;
        document.getElementById('next-btn').disabled = currentPage >= totalPages;
      }

      function changePage(delta) {
        const totalPages = Math.ceil(allTableData.length / rowsPerPage);
        const newPage = currentPage + delta;

        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          renderTable();
        }
      }

      function changePageSize() {
        rowsPerPage = parseInt(document.getElementById('rows-per-page').value);
        currentPage = 1;
        renderTable();
      }

      function exportCSV() {
        if (allTableData.length === 0) {
          alert('No data to export');
          return;
        }

        // Build CSV content with BME280 fields
        const headers = ['id', 'timestamp', 'sensor_id', 'temperature_c', 'temperature_f', 'humidity', 'pressure_hpa', 'dew_point_c', 'dew_point_f'];
        const rows = allTableData.map(row => {
          const tempF = ((row.temperature_c * 9/5) + 32).toFixed(2);
          const pressure = row.pressure_hpa !== null && row.pressure_hpa !== undefined
            ? row.pressure_hpa.toFixed(2)
            : '';
          const dewC = row.dew_point_c !== null && row.dew_point_c !== undefined
            ? row.dew_point_c.toFixed(2)
            : '';
          const dewF = row.dew_point_c !== null && row.dew_point_c !== undefined
            ? ((row.dew_point_c * 9/5) + 32).toFixed(2)
            : '';

          return [
            row.id,
            row.timestamp,
            row.sensor_id,
            row.temperature_c.toFixed(2),
            tempF,
            row.humidity.toFixed(2),
            pressure,
            dewC,
            dewF
          ].join(',');
        });

        const csv = [headers.join(','), ...rows].join('\n');

        // Download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sensor_data_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
